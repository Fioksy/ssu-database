<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Field PDA v4.6 - FIELD UNIT</title>
    <style>
        :root {
            /* UI colours (early 2000s OS vibe) */
            --os-bg: #1b2627;
            --os-panel: #202b2d;
            --os-panel-alt: #263335;
            --os-border-light: #5a7073;
            --os-border-dark: #101415;
            --os-accent: #79c27e;
            --os-accent-soft: #547f59;
            --os-text-main: #d7f0de;
            --os-text-muted: #9ab2a0;
            --os-text-warning: #ffdd88;

            /* Fonts */
            --sys-font: 'Tahoma', 'MS Sans Serif', 'Segoe UI', sans-serif;
            --bios-font: 'Consolas', 'Lucida Console', 'Courier New', monospace;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(circle at top, #252b2e 0%, #050608 55%, #020203 100%);
            font-family: var(--sys-font);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: var(--os-text-main);
        }

        /* PNG SHELL */
        .pda-chassis {
            position: relative;
            width: 1024px;   /* native PNG size */
            height: 702px;
            background: url("pda_background.png") no-repeat center center;
            background-size: contain;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* SCREEN AREA INSIDE SHELL */
        .pda-screen {
            position: absolute;
            left: 85px;
            top: 71px;
            width: 808px;
            height: 555px;
            border-radius: 6px;
            padding: 0;
            background: transparent;
            border: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pda-os-frame {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            height: 100%;
            min-height: 0;
            border-radius: 8px;
            overflow: hidden;
            background: radial-gradient(circle at 50% -40%, #344444 0, #151d1f 55%, #050809 100%);
            box-shadow:
                inset 0 0 0 1px #1a2223,
                0 0 0 1px rgba(0,0,0,0.8);
            transform-origin: center center;
        }

        .chroma-soft {
            text-shadow:
                -1.0px 0 0 rgba(255, 70, 70, 0.55),
                 1.0px 0 0 rgba(0, 230, 255, 0.57),
                 0 1.0px 0 rgba(0, 0, 0, 0.65);
        }

        .screen-noise {
            position: absolute;
            inset: 6px;
            border-radius: 6px;
            pointer-events: none;
            mix-blend-mode: soft-light;
            opacity: 0.25;
            background-image:
                repeating-linear-gradient(
                    0deg,
                    rgba(255,255,255,0.06) 0px,
                    rgba(255,255,255,0.06) 1px,
                    transparent 1px,
                    transparent 3px
                ),
                repeating-linear-gradient(
                    90deg,
                    rgba(0,0,0,0.18) 0px,
                    rgba(0,0,0,0.18) 1px,
                    transparent 1px,
                    transparent 4px
                );
            animation: noise-move 6s steps(8) infinite;
        }

        @keyframes noise-move {
            0%   { background-position: 0 0, 0 0; }
            50%  { background-position: 18px 16px, -14px 18px; }
            100% { background-position: 0 0, 0 0; }
        }

        .screen-vignette {
            position: absolute;
            inset: 0;
            border-radius: 8px;
            pointer-events: none;
            background:
                radial-gradient(circle at 50% 35%,
                    rgba(0,0,0,0) 0%,
                    rgba(0,0,0,0) 42%,
                    rgba(0,0,0,0.85) 100%);
            mix-blend-mode: multiply;
            opacity: 0.15;
        }

        .low-signal-overlay {
            position: absolute;
            inset: 6px;
            border-radius: 6px;
            pointer-events: none;
            background: radial-gradient(circle at 50% 10%,
                rgba(170, 255, 200, 0.25),
                rgba(0, 0, 0, 0.85));
            mix-blend-mode: screen;
            opacity: 0;
        }

        .low-signal-overlay.active {
            animation: lowSignalPulse 20s ease-in-out infinite;
        }

        @keyframes lowSignalPulse {
            0%, 100% { opacity: 0; }
            20%      { opacity: 0.05; }
        }

        .backlight-flicker {
            position: absolute;
            inset: 6px;
            border-radius: 6px;
            pointer-events: none;
            background: radial-gradient(circle at 50% 20%,
                rgba(255, 255, 255, 0.22),
                rgba(0, 0, 0, 0.9));
            mix-blend-mode: screen;
            opacity: 0;
        }

        .backlight-flicker.active {
            animation: backlightFlicker 0.7s ease-out;
        }

        @keyframes backlightFlicker {
            0%   { opacity: 0; }
            20%  { opacity: 0.15; }
            40%  { opacity: 0.07; }
            60%  { opacity: 0.12; }
            100% { opacity: 0; }
        }

        .pda-os-frame.glitch {
            animation: glitch-jitter 160ms ease-out;
        }

        .pda-os-frame.glitch::before,
        .pda-os-frame.glitch::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            height: 14%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0.18),
                rgba(0,0,0,0.35)
            );
            mix-blend-mode: screen;
            opacity: 0.45;
            pointer-events: none;
        }

        .pda-os-frame.glitch::before { top: 22%; }
        .pda-os-frame.glitch::after  { bottom: 18%; }

        @keyframes glitch-jitter {
            0%   { transform: translate(0, 0); }
            30%  { transform: translate(2px, 0); }
            60%  { transform: translate(-2px, 0); }
            100% { transform: translate(0, 0); }
        }

        .screen-cracks {
            position: absolute;
            inset: 6px;
            border-radius: 6px;
            pointer-events: none;
            background: url("overlay.png") center/cover no-repeat;
            mix-blend-mode: screen;
            opacity: 0.08;
            z-index: 9;
        }

        .title-bar {
            background: linear-gradient(to right, #173334, #12302f);
            color: var(--os-text-main);
            padding: 4px 8px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #050707;
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.06),
                0 1px 0 rgba(0,0,0,0.9);
        }

        .title-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .title-icon {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background:
                radial-gradient(circle at 30% 30%, #7cf09a 0, #2c5f3a 45%, #071710 100%);
            box-shadow: 0 0 6px rgba(161, 233, 179, 0.55);
            position: relative;
        }

        .title-icon::before,
        .title-icon::after {
            content: "";
            position: absolute;
            inset: 3px 5px;
            border-radius: 1px;
            border: 1px solid rgba(6,16,10,0.6);
        }

        .title-icon::after {
            inset: 5px 3px;
            border-color: rgba(140,230,162,0.5);
        }

        .title-text-main {
            font-weight: bold;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .title-text-sub {
            font-size: 10px;
            color: var(--os-text-muted);
        }

        .title-right {
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--os-text-muted);
        }

        .zone-tag {
            padding: 1px 6px;
            border-radius: 8px;
            border: 1px solid rgba(122, 192, 126, 0.55);
            background: rgba(19, 46, 31, 0.8);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.11em;
            color: #c6f1cf;
        }

        #pda-clock { font-family: var(--bios-font); }

        .icon-btn {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid #263535;
            background: linear-gradient(to bottom, #273435, #141b1d);
            box-shadow:
                0 1px 0 rgba(255,255,255,0.08),
                0 0 0 1px #000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            cursor: pointer;
        }

        .icon-btn:hover {
            background: linear-gradient(to bottom, #314143, #181f24);
        }

        .icon-btn:active {
            background: #151c1e;
            box-shadow:
                inset 0 0 4px rgba(0,0,0,0.8),
                0 0 0 1px #000;
        }

        .icon-btn .refresh-icon {
            font-size: 11px;
            line-height: 1;
            color: #d4efe0;
        }

        .pda-nav {
            display: flex;
            background: #151c1e;
            border-bottom: 1px solid #000;
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.05),
                0 1px 0 rgba(0,0,0,0.9);
        }

        .nav-btn {
            padding: 6px 18px;
            font-size: 11px;
            cursor: pointer;
            border-right: 1px solid #000;
            border-left: 1px solid #0b1011;
            color: var(--os-text-muted);
            background: linear-gradient(to bottom, #202729, #151b1c);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn::before {
            content: "";
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4c5b5c 0, #1a2224 60%, #050a0b 100%);
            box-shadow: 0 0 3px rgba(0,0,0,0.9);
        }

        .nav-btn:hover {
            background: linear-gradient(to bottom, #293234, #181f20);
        }

        .nav-btn.active {
            background: linear-gradient(to bottom, #2a3c3c, #192828);
            color: var(--os-text-main);
            box-shadow:
                inset 0 0 0 1px #3d5253,
                0 0 0 1px #000;
        }

        .nav-btn.active::before {
            background: radial-gradient(circle at 30% 30%, #8ff0a3 0, #2a6b3a 50%, #041108 100%);
            box-shadow: 0 0 6px rgba(117, 218, 142, 0.9);
        }

        .viewport {
            flex: 1 1 auto;
            min-height: 0;
            margin: 6px;
            border-radius: 6px;
            border: 1px solid #070b0c;
            box-shadow:
                inset 0 0 0 1px #273133,
                0 0 0 1px rgba(0,0,0,0.8);
            background: radial-gradient(circle at 50% 0%, rgba(108,179,133,0.06) 0, transparent 60%) #0b1213;
            overflow-y: auto;
        }

        .viewport::-webkit-scrollbar { width: 10px; }
        .viewport::-webkit-scrollbar-track { background: #05080a; }
        .viewport::-webkit-scrollbar-thumb {
            background: #283336;
            border-radius: 8px;
            border: 1px solid #05080a;
        }

        .stalker-toolbar {
            padding: 4px 8px;
            background: rgba(5, 10, 11, 0.9);
            border-bottom: 1px solid #0f1819;
            font-size: 10px;
            color: var(--os-text-muted);
            display: none;
            align-items: center;
            gap: 6px;
        }

        .stalker-toolbar input {
            max-width: 230px;
            height: 20px;
            font-size: 10px;
            border-radius: 3px;
            border: 1px solid #232c2e;
            padding: 2px 4px;
            background: #0c1112;
            color: var(--os-text-main);
            box-shadow:
                inset 0 0 0 1px #050708,
                0 0 0 1px rgba(0,0,0,0.9);
        }

        .stalker-toolbar input::placeholder {
            color: #4c5f57;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            display: none;
            font-size: 11px;
            color: var(--os-text-main);
        }
        table.active { display: table; }

        th {
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: left;
            padding: 6px 8px;
            background: linear-gradient(to bottom, #1a2426, #12191b);
            border-bottom: 1px solid #030708;
            border-top: 1px solid #354345;
            border-right: 1px solid #131b1c;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: normal;
            color: #aee4b8;
        }

        .actions-col {
            width: 28px;
            text-align: center;
        }

        #table-Stalkers thead th:not(.actions-col) {
            cursor: pointer;
            user-select: none;
        }

        td {
            border-bottom: 1px solid #111618;
            border-right: 1px solid #0c1011;
            padding: 4px 6px;
        }

        input,
        select {
            width: 100%;
            height: 26px;
            border-radius: 3px;
            border: 1px solid #232c2e;
            padding: 3px 4px;
            font-size: 11px;
            font-family: var(--sys-font);
            background: radial-gradient(circle at 50% 0%, #283634 0, #141b1c 80%);
            color: var(--os-text-main);
            box-shadow:
                inset 0 0 0 1px #0d1314,
                0 0 0 1px rgba(0,0,0,0.7);
        }

        input::placeholder { color: #556e5e; }
        select option { background-color: #06090a; color: var(--os-text-main); }

        input:focus,
        select:focus {
            outline: none;
            border-color: #62b973;
            box-shadow:
                0 0 0 1px rgba(124, 220, 146, 0.7),
                0 0 8px rgba(124, 220, 146, 0.5);
        }

        .row-delete-btn {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border: 1px solid #3a2020;
            background: radial-gradient(circle at 30% 30%, #7d2e2e 0, #3b1414 60%, #1a0505 100%);
            box-shadow:
                0 1px 0 rgba(255,255,255,0.05),
                0 0 0 1px #000;
            color: #ffb7b7;
            font-size: 11px;
            line-height: 1;
            padding: 0;
            cursor: pointer;
        }

        .row-delete-btn:hover {
            background: radial-gradient(circle at 30% 30%, #a63c3c 0, #4a1818 60%, #1f0606 100%);
        }

        .row-delete-btn:active {
            background: #2a0808;
            box-shadow:
                inset 0 0 4px rgba(0,0,0,0.8),
                0 0 0 1px #000;
        }

        #table-Stalkers th:nth-child(3),
        #table-Stalkers td:nth-child(3) {
            width: 55%;
        }

        #table-Stalkers th:nth-child(4),
        #table-Stalkers td:nth-child(4) {
            width: 1%;
            white-space: nowrap;
        }

        .action-bar {
            padding: 6px 8px;
            background: #0c1314;
            border-top: 1px solid #000;
            display: flex;
            gap: 8px;
            align-items: center;
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.03),
                0 -1px 0 rgba(0,0,0,0.9);
        }

        .gloss-btn {
            background: linear-gradient(to bottom, #293435, #141b1c);
            border-radius: 4px;
            border: 1px solid #1e292b;
            box-shadow:
                0 1px 0 rgba(255,255,255,0.05),
                0 0 0 1px rgba(0,0,0,0.9);
            padding: 5px 14px;
            font-size: 11px;
            color: var(--os-text-main);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
        }

        .gloss-btn:hover {
            background: linear-gradient(to bottom, #314042, #181f21);
        }

        .gloss-btn:active {
            background: #151c1e;
            box-shadow:
                inset 0 0 6px rgba(0,0,0,0.7),
                0 0 0 1px rgba(0,0,0,1);
        }

        .commit-btn {
            background: linear-gradient(to bottom, #3b6b40, #1b3b23);
            border-color: #18411f;
            box-shadow:
                0 1px 0 rgba(180, 242, 193, 0.3),
                0 0 0 1px rgba(0,0,0,1);
        }

        .commit-btn:hover {
            background: linear-gradient(to bottom, #48854f, #21512c);
        }

        .status-footer {
            background: #05090a;
            color: var(--os-text-muted);
            padding: 4px 10px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #000;
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.03),
                0 -1px 0 rgba(0,0,0,0.9);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-label { color: #9eb5a5; }
        .status-value { font-family: var(--bios-font); font-size: 10px; }

        .signal-bar {
            display: inline-flex;
            gap: 2px;
            align-items: flex-end;
            margin-right: 6px;
        }

        .signal-bar span {
            width: 3px;
            border-radius: 1px 1px 0 0;
            background: #384546;
        }

        .signal-bar span:nth-child(1) { height: 4px; }
        .signal-bar span:nth-child(2) { height: 6px; }
        .signal-bar span:nth-child(3) { height: 8px; }
        .signal-bar span:nth-child(4) { height: 10px; }
        .signal-bar span:nth-child(5) { height: 12px; }

        .signal-bar span.active { background: #62b973; }

        .buffer-wheel {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 2px solid #273435;
            border-top: 2px solid #8fd9a1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 4px;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* BIOS COVER */
        #boot-cover {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9998;
            pointer-events: none;
            display: none;
        }

        /* BIOS SCREEN */
        #boot-screen {
            position: fixed;
            inset: 0;
            margin: 0;
            background: #000000;
            color: #f4f4f4;
            font-family: var(--bios-font);
            font-weight: 700;
            padding: 22px 28px;
            z-index: 9999;
            box-sizing: border-box;
            overflow: hidden;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #boot-screen::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background:
                radial-gradient(circle at 50% 10%, rgba(255,255,255,0.12), transparent 60%),
                radial-gradient(circle at 50% 120%, rgba(0, 255, 160, 0.18), transparent 70%);
            mix-blend-mode: screen;
            opacity: 0.55;
        }

        #boot-log {
            position: relative;
            font-size: 13px;
            line-height: 1.2;
            max-width: 80ch;
            white-space: pre;
            overflow: hidden;
            margin-bottom: 6px;
            text-align: left;
            text-shadow:
                0 0 6px rgba(255,255,255,0.7),
                0 0 14px rgba(160, 255, 200, 0.5),
                0 0 22px rgba(70, 200, 140, 0.35);
            animation: biosGlow 3.2s ease-in-out infinite alternate;
        }

        .boot-line { display: block; }

        .boot-logo-block {
            display: block;
            margin: 4px auto 8px;
            text-align: center;
            transform: scaleX(1.35) scaleY(0.8);
            transform-origin: center center;
        }

        .boot-logo-line { display: block; }

        .bios-bar-container {
            width: 70%;
            border: 1px solid #888;
            height: 8px;
            margin-top: 8px;
            background: #111;
            box-shadow: inset 0 0 4px #000;
            position: relative;
        }

        #bios-bar-fill {
            width: 0%;
            background: linear-gradient(to right, #d0d0d0, #ffffff);
            height: 100%;
            box-shadow: 0 0 6px rgba(255,255,255,0.5);
        }

        #bios-status {
            margin-top: 8px;
            font-size: 11px;
            color: #cfcfcf;
            font-family: var(--bios-font);
            text-shadow: 0 0 6px rgba(255,255,255,0.4);
        }

        @keyframes biosGlow {
            0% {
                text-shadow:
                    0 0 4px rgba(255,255,255,0.4),
                    0 0 10px rgba(140, 240, 190, 0.3),
                    0 0 18px rgba(40, 200, 120, 0.2);
            }
            100% {
                text-shadow:
                    0 0 8px rgba(255,255,255,0.9),
                    0 0 18px rgba(180, 255, 210, 0.6),
                    0 0 30px rgba(60, 255, 160, 0.4);
            }
        }

        /* START OVERLAY */
        #start-overlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background:
                radial-gradient(circle at 50% 0%, rgba(40, 60, 60, 0.25), transparent 55%),
                #020304;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .start-panel {
            background: #050b0c;
            border-radius: 10px;
            border: 1px solid #263335;
            box-shadow:
                0 0 0 1px #000,
                0 18px 40px rgba(0,0,0,0.9);
            padding: 20px 26px 18px;
            min-width: 220px;
            text-align: center;
            color: var(--os-text-main);
            font-size: 11px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* NEW: mid-2000s style app icon using the UA flag image */
        .start-icon {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            padding: 4px;
            background: linear-gradient(to bottom, #3b4c60, #1b2633);
            box-shadow:
                0 1px 0 rgba(255,255,255,0.12),
                0 0 0 1px #000,
                0 12px 22px rgba(0,0,0,0.85);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .start-icon-inner {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background: radial-gradient(circle at 30% 15%, rgba(255,255,255,0.4), transparent 50%);
            overflow: hidden;
        }

        .start-icon-img {
            position: absolute;
            inset: 8px;
            width: auto;
            height: auto;
            max-width: calc(100% - 16px);
            max-height: calc(100% - 16px);
            object-fit: contain;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.6));
        }

        .start-icon-led {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            bottom: 7px;
            right: 7px;
            background: radial-gradient(circle at 30% 30%, #8cff9a 0, #2a5b31 70%, #041108 100%);
            box-shadow:
                0 0 3px rgba(150, 255, 180, 0.9),
                0 0 8px rgba(80, 200, 120, 0.8);
        }

        #start-btn {
            margin-top: 4px;
            padding: 6px 18px;
            border-radius: 5px;
            border: 1px solid #1e292b;
            background: linear-gradient(to bottom, #2f433f, #182626);
            color: #d7f0de;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            cursor: pointer;
            box-shadow:
                0 1px 0 rgba(255,255,255,0.08),
                0 0 0 1px #000;
        }

        #start-btn:hover {
            background: linear-gradient(to bottom, #37504a, #1b2d2b);
        }

        #start-btn:active {
            background: #142021;
            box-shadow:
                inset 0 0 6px rgba(0,0,0,0.7),
                0 0 0 1px #000;
        }

        #uplink-overlay {
            position: absolute;
            inset: 6px;
            border-radius: 6px;
            background: rgba(1,5,3,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }

        #uplink-overlay > div {
            background: #061011;
            padding: 18px 26px;
            border-radius: 10px;
            border: 1px solid #62b973;
            box-shadow:
                0 0 0 1px #000,
                0 18px 40px rgba(0,0,0,0.85);
            color: var(--os-text-main);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #uplink-overlay p { margin: 0; }

        #uplink-overlay .buffer-wheel {
            width: 22px;
            height: 22px;
            border-width: 3px;
            margin: 0 0 10px 0;
        }

        #error-overlay {
            position: absolute;
            inset: 6px;
            border-radius: 6px;
            background: rgba(30, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        #error-overlay > div {
            background: #260000;
            padding: 16px 22px;
            border-radius: 8px;
            border: 1px solid #ff4a4a;
            box-shadow:
                0 0 0 1px #000,
                0 18px 40px rgba(0,0,0,0.9);
            color: #ffbbbb;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            text-align: center;
        }

        #error-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #ff6666;
        }

        #error-text {
            font-family: var(--bios-font);
        }

        #table-Relations tbody tr.relation-allied input,
        #table-Relations tbody tr.relation-allied select {
            background: radial-gradient(circle at 50% 0%, #3f6b4c 0, #18241c 80%);
            border-color: #4fa86a;
            box-shadow:
                inset 0 0 0 1px #1b2b22,
                0 0 0 1px rgba(0,0,0,0.8);
        }

        #table-Relations tbody tr.relation-neutral input,
        #table-Relations tbody tr.relation-neutral select {
            background: radial-gradient(circle at 50% 0%, #6c5f32 0, #292315 80%);
            border-color: #c7b763;
            box-shadow:
                inset 0 0 0 1px #3b3218,
                0 0 0 1px rgba(0,0,0,0.8);
        }

        #table-Relations tbody tr.relation-hostile input,
        #table-Relations tbody tr.relation-hostile select {
            background: radial-gradient(circle at 50% 0%, #6b3232 0, #2a1212 80%);
            border-color: #c97373;
            box-shadow:
                inset 0 0 0 1px #3b1818,
                0 0 0 1px rgba(0,0,0,0.8);
        }

        #table-Relations tbody tr.relation-war input,
        #table-Relations tbody tr.relation-war select {
            background: radial-gradient(circle at 50% 0%, #3a0202 0, #050000 80%);
            border-color: #f24444;
            box-shadow:
                inset 0 0 0 1px #3a0000,
                0 0 6px rgba(255, 40, 40, 0.4);
            color: #f5eaea;
        }

        #table-Personnel tbody tr.personnel-active input,
        #table-Personnel tbody tr.personnel-active select {
            background: radial-gradient(circle at 50% 0%, #3f6b4c 0, #18241c 80%);
            border-color: #4fa86a;
            box-shadow:
                inset 0 0 0 1px #1b2b22,
                0 0 0 1px rgba(0,0,0,0.8);
        }

        #table-Personnel tbody tr.personnel-onleave input,
        #table-Personnel tbody tr.personnel-onleave select {
            background: radial-gradient(circle at 50% 0%, #4b4f52 0, #1d2022 80%);
            border-color: #7f8489;
            box-shadow:
                inset 0 0 0 1px #343639,
                0 0 0 1px rgba(0,0,0,0.8);
        }

        #table-Stalkers tbody tr.stalker-wanted input,
        #table-Stalkers tbody tr.stalker-wanted select {
            background: radial-gradient(circle at 50% 0%, #6b3232 0, #2a1212 80%);
            border-color: #c97373;
            box-shadow:
                inset 0 0 0 1px #3b1818,
                0 0 0 1px rgba(0,0,0,0.8);
        }

        .rep-control {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        .rep-control .rep-value {
            width: 60px;
            text-align: right;
            font-family: var(--bios-font);
            background: #0c1112;
            border: 1px solid #30393b;
            box-shadow:
                inset 0 0 0 1px #050708,
                0 0 0 1px rgba(0,0,0,0.9);
        }

        .rep-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .rep-control .rep-btn {
            width: 20px;
            height: 14px;
            padding: 0;
            font-size: 10px;
            line-height: 1;
            border-radius: 2px;
            border: 1px solid #30393b;
            background: linear-gradient(to bottom, #242b2e, #151b1d);
            color: var(--os-text-main);
            cursor: pointer;
        }

        .rep-btn-up   { color: #a3f7b4; }
        .rep-btn-down { color: #ff8a8a; }

        .rep-control .rep-btn:hover {
            background: linear-gradient(to bottom, #2d3538, #171d1f);
        }

        .rep-control .rep-btn:active {
            background: #13191b;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.8);
        }

        .screen-overlay {
            position: absolute;
            inset: 0;
            border-radius: 6px;
            pointer-events: none;
            z-index: 10;
        }

        .screen-dirt {
            mix-blend-mode: multiply;
            background:
                radial-gradient(circle at 20% 10%, rgba(255,255,255,0.05), transparent 60%),
                radial-gradient(circle at 80% 90%, rgba(0,0,0,0.35), transparent 70%);
            opacity: 0.12;
        }

        .screen-scratches {
            mix-blend-mode: screen;
            background:
                repeating-linear-gradient(
                    120deg,
                    rgba(255,255,255,0.08) 0px,
                    rgba(255,255,255,0.08) 1px,
                    transparent 3px,
                    transparent 8px
                );
            opacity: 0.06;
        }

        @keyframes pdaBootIn {
            0% {
                opacity: 0.0;
                transform: scale(0.97) translateY(6px);
                filter: blur(2px);
            }
            60% {
                opacity: 1;
                transform: scale(1.01) translateY(0);
                filter: blur(0.5px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
                filter: blur(0);
            }
        }

        .pda-os-frame.pda-appear {
            animation: pdaBootIn 420ms ease-out;
        }
    </style>
</head>
<body>

<!-- START / LAUNCH OVERLAY -->
<div id="start-overlay">
    <div class="start-panel">
        <div class="start-icon">
            <div class="start-icon-inner">
                <img src="ua_flag.png" alt="Database Icon" class="start-icon-img">
            </div>
            <div class="start-icon-led"></div>
        </div>
        <button id="start-btn">LAUNCH DATABASE</button>
    </div>
</div>

<!-- BIOS black cover + boot overlay -->
<div id="boot-cover"></div>

<div id="boot-screen">
    <div id="boot-log"></div>
    <div class="bios-bar-container">
        <div id="bios-bar-fill"></div>
    </div>
    <div id="bios-status">INITIALIZING...</div>
</div>

<div class="pda-chassis">
    <div class="pda-screen">
        <div class="pda-os-frame">
            <!-- UPLINK overlay -->
            <div id="uplink-overlay">
                <div>
                    <div class="buffer-wheel"></div>
                    <p><b>SYNCING WITH SSU DATABASE...</b></p>
                </div>
            </div>

            <!-- ERROR overlay -->
            <div id="error-overlay">
                <div>
                    <div id="error-title">SIGNAL LOST</div>
                    <div id="error-text">ERROR 404 &mdash; REMOTE CHANGES DETECTED</div>
                </div>
            </div>

            <!-- TITLE BAR -->
            <div class="title-bar chroma-soft">
                <div class="title-left">
                    <div class="title-icon"></div>
                    <div>
                        <div class="title-text-main">FIELD OPS PDA</div>
                        <div class="title-text-sub">FIELD TERMINAL &mdash; CHORNOBYL EXCLUSION ZONE : NORTH</div>
                    </div>
                </div>
                <div class="title-right">
                    <span class="zone-tag">SECTOR 04 â€¢ ONLINE</span>
                    <button class="icon-btn" id="refresh-btn" onclick="loadFromCloud(true)" title="Refresh / Force Sync">
                        <span class="refresh-icon">&#10227;</span>
                    </button>
                    <span id="pda-clock">--:--:--</span>
                </div>
            </div>

            <!-- NAVIGATION -->
            <div class="pda-nav chroma-soft">
                <div class="nav-btn active" id="btn-Personnel" onclick="switchTab('Personnel')">PERSONNEL</div>
                <div class="nav-btn" id="btn-Stalkers" onclick="switchTab('Stalkers')">STALKERS</div>
                <div class="nav-btn" id="btn-Relations" onclick="switchTab('Relations')">FACTIONS</div>
            </div>

            <!-- MAIN DATA VIEWPORT -->
            <div class="viewport">
                <div id="stalker-toolbar" class="stalker-toolbar">
                    <span>FILTER:</span>
                    <input type="text" id="stalker-search" placeholder="Search">
                </div>

                <table id="table-Personnel" class="active">
                    <thead>
                        <tr>
                            <th>NAME</th>
                            <th>RANK</th>
                            <th>SPECIALISATION</th>
                            <th>STATUS</th>
                            <th class="actions-col"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <table id="table-Stalkers">
                    <thead>
                        <tr>
                            <th>ALIAS</th>
                            <th>STATUS</th>
                            <th>TASK</th>
                            <th>REPUTATION</th>
                            <th class="actions-col"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <table id="table-Relations">
                    <thead>
                        <tr>
                            <th>FACTION</th>
                            <th>RELATION STATUS</th>
                            <th>ROE / NOTES</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- ACTION BAR -->
            <div class="action-bar">
                <button class="gloss-btn" onclick="addNewRow()">+ ADD NEW ENTRY</button>
                <div style="flex-grow:1"></div>
                <button class="gloss-btn commit-btn" onclick="saveToCloud()">COMMIT TO DATABASE</button>
            </div>

            <!-- STATUS BAR -->
            <div class="status-footer">
                <div class="status-left">
                    <span id="status-spinner" class="buffer-wheel" style="display:none;"></span>
                    <span class="status-label">STATUS:</span>
                    <span id="sync-status" class="status-value">READY</span>
                </div>
                <div>
                    <span class="signal-bar">
                        <span></span><span></span><span></span><span></span><span></span>
                    </span>
                    <span class="status-label">Uplink:</span>
                    <span class="status-value">PRIPYAT SAT-NET &bull; 21%</span>
                </div>
            </div>

            <!-- internal screen effects -->
            <div class="screen-vignette"></div>
            <div id="low-signal-overlay" class="low-signal-overlay"></div>
            <div id="backlight-flicker" class="backlight-flicker"></div>
            <div class="screen-noise"></div>
        </div>

        <!-- cracked glass overlay -->
        <div class="screen-cracks"></div>

        <!-- GLASS GRIME OVERLAYS -->
        <div class="screen-overlay screen-dirt"></div>
        <div class="screen-overlay screen-scratches"></div>
    </div>
</div>

<script>
    const UPLINK_URL = "https://script.google.com/macros/s/AKfycbyqfwn91pnhsTSG2mlPIG1X9OSpPwnnk_ur3JtpOMtxzwVR1I4iR4jFwxEgSj2Xg_VR/exec";
    let currentTab = "Personnel";

    const sheetCache = { Personnel: null, Stalkers: null, Relations: null };
    const sheetRevision = { Personnel: null, Stalkers: null, Relations: null };

    let currentSignal = 1;
    let signalBars = null;
    let lowSignalOverlay = null;
    let backlightOverlay = null;

    let stalkerSortState = { column: null, direction: 'asc' };

    function getAudioCtx() {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return null;
        if (!window._pdaAudioCtx) {
            window._pdaAudioCtx = new AudioCtx();
        }
        return window._pdaAudioCtx;
    }

    function playBootSound() {
        const ctx = getAudioCtx();
        if (!ctx) return;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "square";
        osc.frequency.value = 420;

        osc.connect(gain);
        gain.connect(ctx.destination);

        const now = ctx.currentTime;
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.25);

        osc.start(now);
        osc.stop(now + 0.3);
    }

    function playBootChime() {
        const ctx = getAudioCtx();
        if (!ctx) return;
        const now = ctx.currentTime;

        function note(freq, start, dur, vol) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = "sine";
            osc.frequency.setValueAtTime(freq, now + start);
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.setValueAtTime(vol, now + start);
            gain.gain.exponentialRampToValueAtTime(0.001, now + start + dur);
            osc.start(now + start);
            osc.stop(now + start + dur + 0.05);
        }

        note(740, 0.00, 0.20, 0.15);
        note(1040, 0.16, 0.22, 0.13);
    }

    function playTabClick() {
        const ctx = getAudioCtx();
        if (!ctx) return;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "square";
        osc.frequency.value = 2100;
        osc.connect(gain);
        gain.connect(ctx.destination);

        const now = ctx.currentTime;
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.04);

        osc.start(now);
        osc.stop(now + 0.06);
    }

    function updateSignalBars() {
        if (!signalBars) return;
        signalBars.forEach((bar, i) => {
            if (currentSignal === 0) {
                bar.classList.remove('active');
            } else {
                if (i < currentSignal) bar.classList.add('active');
                else bar.classList.remove('active');
            }
        });

        if (lowSignalOverlay) {
            if (currentSignal === 1) lowSignalOverlay.classList.add('active');
            else lowSignalOverlay.classList.remove('active');
        }
    }

    function initSignalBars() {
        signalBars = document.querySelectorAll('.signal-bar span');
        lowSignalOverlay = document.getElementById('low-signal-overlay');
        backlightOverlay = document.getElementById('backlight-flicker');

        currentSignal = Math.random() < 0.7 ? 1 : 2;
        updateSignalBars();

        setInterval(() => {
            if (currentSignal === 0) return;
            const r = Math.random();
            if (r < 0.6) return;
            const delta = Math.random() < 0.5 ? -1 : 1;
            currentSignal = Math.min(3, Math.max(1, currentSignal + delta));
            updateSignalBars();
        }, 180000);
    }

    function showErrorOverlay(message) {
        const overlay = document.getElementById('error-overlay');
        const textEl = document.getElementById('error-text');
        textEl.innerHTML = message || "ERROR 404 &mdash; REMOTE CHANGES DETECTED";

        currentSignal = 0;
        updateSignalBars();

        overlay.style.display = 'flex';
        setTimeout(() => { overlay.style.display = 'none'; }, 2300);
    }

    function updatePersonnelRowStyle(tr, value) {
        tr.classList.remove('personnel-active', 'personnel-onleave');
        if (value === 'On Leave') tr.classList.add('personnel-onleave');
        else if (value === 'Active') tr.classList.add('personnel-active');
    }

    function updateRelationRowStyle(tr, value) {
        tr.classList.remove('relation-allied', 'relation-neutral', 'relation-hostile', 'relation-war');
        if      (value === 'Allied')  tr.classList.add('relation-allied');
        else if (value === 'Neutral') tr.classList.add('relation-neutral');
        else if (value === 'Hostile') tr.classList.add('relation-hostile');
        else if (value === 'War')     tr.classList.add('relation-war');
    }

    function updateStalkerRowStyle(tr, value) {
        tr.classList.remove('stalker-wanted');
        if (value === 'Wanted') tr.classList.add('stalker-wanted');
    }

    function attachDeleteHandler(tr, labelFieldIndex = 0) {
        const btn = tr.querySelector('.row-delete-btn');
        if (!btn) return;
        btn.addEventListener('click', () => {
            const labelInput = tr.querySelector(`td:nth-child(${labelFieldIndex + 1}) input`);
            const label = labelInput && labelInput.value.trim()
                ? labelInput.value.trim()
                : 'this entry';
            if (!confirm(`Remove ${label}?`)) return;
            tr.remove();
        });
    }

    async function switchTab(tabName) {
        playTabClick();
        currentTab = tabName;

        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + tabName).classList.add('active');
        document.querySelectorAll('table').forEach(t => t.classList.remove('active'));
        document.getElementById('table-' + tabName).classList.add('active');

        const toolbar = document.getElementById('stalker-toolbar');
        if (toolbar) toolbar.style.display = (tabName === 'Stalkers') ? 'flex' : 'none';

        await loadFromCloud();
    }

    async function loadFromCloud(force = false) {
        const body = document.querySelector(`#table-${currentTab} tbody`);

        if (!force && sheetCache[currentTab]) {
            body.innerHTML = "";
            sheetCache[currentTab].forEach(rowData => renderRow(rowData));
            document.getElementById('sync-status').innerText = "CACHED";
            if (currentTab === 'Stalkers') applyStalkerFilter();
            return;
        }

        document.getElementById('sync-status').innerText = "FETCHING";
        document.getElementById('status-spinner').style.display = 'inline-block';

        try {
            const response = await fetch(`${UPLINK_URL}?sheet=${currentTab}`);
            const payload = await response.json();

            const data = payload.rows || [];
            const revision = payload.revision ?? null;

            sheetCache[currentTab] = data;
            sheetRevision[currentTab] = revision;

            body.innerHTML = "";
            data.forEach(rowData => renderRow(rowData));
            document.getElementById('sync-status').innerText = "SYNCHRONIZED";

            if (currentSignal === 0) {
                currentSignal = Math.random() < 0.7 ? 1 : 2;
                updateSignalBars();
            }

            if (currentTab === 'Stalkers') applyStalkerFilter();

        } catch (e) {
            document.getElementById('sync-status').innerText = "OFFLINE";
        }

        document.getElementById('status-spinner').style.display = 'none';
    }

    async function saveToCloud() {
        if (currentTab === "Stalkers") {
            const stalkerRows = Array.from(document.querySelectorAll('#table-Stalkers tbody tr'));
            let hasMissingAlias = false;
            stalkerRows.forEach(tr => {
                const aliasInput = tr.querySelector('td:nth-child(1) input');
                if (!aliasInput || !aliasInput.value.trim()) hasMissingAlias = true;
            });
            if (hasMissingAlias) {
                document.getElementById('sync-status').innerText = "ALIAS MISSING";
                alert("Cannot commit: all Stalker entries must have an ALIAS.");
                return;
            }
        }

        document.getElementById('uplink-overlay').style.display = 'flex';

        const rows = Array.from(document.querySelectorAll(`#table-${currentTab} tbody tr`)).map(tr =>
            Array.from(tr.querySelectorAll('input, select')).map(el => el.value)
        );

        try {
            const response = await fetch(UPLINK_URL, {
                method: "POST",
                body: JSON.stringify({
                    targetSheet: currentTab,
                    rows: rows,
                    lastRevision: sheetRevision[currentTab]
                })
            });

            const replyText = await response.text();
            let reply;
            try { reply = JSON.parse(replyText); }
            catch (e) {
                document.getElementById('sync-status').innerText = "UPLINK OK";
                sheetCache[currentTab] = rows;
                return;
            }

            if (reply.status === "CONFLICT") {
                document.getElementById('sync-status').innerText = "CONFLICT - RELOADING";
                if (typeof reply.revision !== "undefined") sheetRevision[currentTab] = reply.revision;
                showErrorOverlay("ERROR 404 &mdash; REMOTE CHANGES DETECTED<br>RELOADING FROM UPLINK...");
                await loadFromCloud(true);
            } else if (reply.status === "OK") {
                sheetCache[currentTab] = rows;
                if (typeof reply.revision !== "undefined") sheetRevision[currentTab] = reply.revision;
                document.getElementById('sync-status').innerText = "LOCAL + REMOTE";

                if (currentSignal === 0) {
                    currentSignal = Math.random() < 0.7 ? 1 : 2;
                    updateSignalBars();
                }
            } else if (reply.status === "ERROR") {
                document.getElementById('sync-status').innerText = "ERROR";
            } else {
                document.getElementById('sync-status').innerText = "UNKNOWN RESPONSE";
            }

        } catch (e) {
            document.getElementById('sync-status').innerText = "OFFLINE";
        } finally {
            document.getElementById('uplink-overlay').style.display = 'none';
        }
    }

    function renderRow(rowData = null) {
        const body = document.querySelector(`#table-${currentTab} tbody`);
        const tr = document.createElement('tr');

        if (currentTab === "Personnel") {
            const data = rowData || ["", "Junior Sergeant", "", "Active"];
            const rawStatus = data[3] || "Active";
            const status = (rawStatus === "On Leave") ? "On Leave" : "Active";

            tr.innerHTML = `
                <td><input type="text" placeholder="NAME" value="${data[0]}"></td>
                <td>
                    <select>
                        <option ${data[1]=='Junior Sergeant'?'selected':''}>Junior Sergeant</option>
                        <option ${data[1]=='Sergeant'?'selected':''}>Sergeant</option>
                        <option ${data[1]=='Senior Sergeant'?'selected':''}>Senior Sergeant</option>
                        <option ${data[1]=='Master Sergeant'?'selected':''}>Master Sergeant</option>
                        <option ${data[1]=='Junior Lieutenant'?'selected':''}>Junior Lieutenant</option>
                        <option ${data[1]=='Lieutenant'?'selected':''}>Lieutenant</option>
                        <option ${data[1]=='Captain'?'selected':''}>Captain</option>
                    </select>
                </td>
                <td><input type="text" placeholder="E.G. SNIPER, MEDIC, TECH" value="${data[2]}"></td>
                <td>
                    <select>
                        <option ${status=='Active'?'selected':''}>Active</option>
                        <option ${status=='On Leave'?'selected':''}>On Leave</option>
                    </select>
                </td>
                <td class="actions-col" style="text-align:center;">
                    <button type="button" class="row-delete-btn" title="Remove entry">&times;</button>
                </td>
            `;

            updatePersonnelRowStyle(tr, status);
            const statusSelect = tr.querySelector('td:nth-child(4) select');
            statusSelect.addEventListener('change', function () {
                updatePersonnelRowStyle(tr, this.value);
            });

            attachDeleteHandler(tr, 0);

        } else if (currentTab === "Relations") {
            const data = rowData || ["", "Neutral", ""];
            tr.innerHTML = `
                <td><input type="text" placeholder="FACTION NAME" value="${data[0]}"></td>
                <td>
                    <select>
                        <option ${data[1]=='Allied'?'selected':''}>Allied</option>
                        <option ${data[1]=='Neutral'?'selected':''}>Neutral</option>
                        <option ${data[1]=='Hostile'?'selected':''}>Hostile</option>
                        <option ${data[1]=='War'?'selected':''}>War</option>
                    </select>
                </td>
                <td><input type="text" placeholder="ROE / NOTES" value="${data[2]}"></td>
            `;
            const selectEl = tr.querySelector('select');
            updateRelationRowStyle(tr, selectEl.value);
            selectEl.addEventListener('change', function () {
                updateRelationRowStyle(tr, this.value);
            });

        } else if (currentTab === "Stalkers") {
            const data = rowData || ["", "Collaborator", "", "0"];
            const alias = data[0] || "";
            let status = (data[1] === "Wanted") ? "Wanted" : "Collaborator";
            const task = data[2] || "";
            let rep = parseInt(data[3], 10);
            if (isNaN(rep)) rep = 0;

            tr.innerHTML = `
                <td><input type="text" placeholder="ALIAS" value="${alias}"></td>
                <td>
                    <select class="stalker-status">
                        <option ${status==='Collaborator'?'selected':''}>Collaborator</option>
                        <option ${status==='Wanted'?'selected':''}>Wanted</option>
                    </select>
                </td>
                <td><input type="text" placeholder="TASK" value="${task}"></td>
                <td class="rep-cell">
                    <div class="rep-control">
                        <input type="text" class="rep-value" value="${rep}" readonly>
                        <div class="rep-buttons">
                            <button type="button" class="rep-btn rep-btn-up rep-inc">â–²</button>
                            <button type="button" class="rep-btn rep-btn-down rep-dec">â–¼</button>
                        </div>
                    </div>
                </td>
                <td class="actions-col" style="text-align:center;">
                    <button type="button" class="row-delete-btn" title="Remove entry">&times;</button>
                </td>
            `;

            updateStalkerRowStyle(tr, status);
            const statusSelect = tr.querySelector('.stalker-status');
            statusSelect.addEventListener('change', function () {
                updateStalkerRowStyle(tr, this.value);
            });

            const repInput = tr.querySelector('.rep-value');
            tr.querySelector('.rep-inc').addEventListener('click', () => {
                let v = parseInt(repInput.value || "0", 10);
                if (isNaN(v)) v = 0;
                repInput.value = v + 100;
            });
            tr.querySelector('.rep-dec').addEventListener('click', () => {
                let v = parseInt(repInput.value || "0", 10);
                if (isNaN(v)) v = 0;
                repInput.value = v - 100;
            });

            attachDeleteHandler(tr, 0);

            const searchInput = document.getElementById('stalker-search');
            if (searchInput && searchInput.value.trim() !== '') {
                applyStalkerFilter();
            }

        } else {
            const colCount = document.querySelectorAll(`#table-${currentTab} th`).length;
            const data = rowData || new Array(colCount).fill("");
            data.forEach((val, idx) => {
                const td = document.createElement('td');
                td.innerHTML = `<input type="text" value="${val}">`;
                tr.appendChild(td);
            });
        }

        body.appendChild(tr);
    }

    function addNewRow() { renderRow(); }

    function applyStalkerFilter() {
        const input = document.getElementById('stalker-search');
        if (!input) return;
        const q = input.value.toLowerCase().trim();
        const tbody = document.querySelector('#table-Stalkers tbody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.forEach(tr => {
            if (!q) { tr.style.display = ''; return; }
            const alias = (tr.querySelector('td:nth-child(1) input')?.value || '').toLowerCase();
            const task  = (tr.querySelector('td:nth-child(3) input')?.value || '').toLowerCase();
            tr.style.display = (alias.includes(q) || task.includes(q)) ? '' : 'none';
        });
    }

    function getStalkerSortValue(tr, by) {
        if (by === 'alias') {
            return (tr.querySelector('td:nth-child(1) input')?.value || '').toLowerCase();
        } else if (by === 'status') {
            return (tr.querySelector('.stalker-status')?.value || '').toLowerCase();
        } else if (by === 'rep') {
            const v = parseInt(tr.querySelector('.rep-value')?.value || "0", 10);
            return isNaN(v) ? 0 : v;
        }
        return '';
    }

    function sortStalkers(by) {
        const tbody = document.querySelector('#table-Stalkers tbody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (!rows.length) return;

        let direction = 'asc';
        if (stalkerSortState.column === by) {
            direction = (stalkerSortState.direction === 'asc') ? 'desc' : 'asc';
        }
        stalkerSortState = { column: by, direction };

        rows.sort((a, b) => {
            const va = getStalkerSortValue(a, by);
            const vb = getStalkerSortValue(b, by);
            let cmp = 0;
            if (typeof va === 'number' && typeof vb === 'number') {
                cmp = va - vb;
            } else {
                if (va < vb) cmp = -1;
                else if (va > vb) cmp = 1;
            }
            return direction === 'asc' ? cmp : -cmp;
        });

        rows.forEach(tr => tbody.appendChild(tr));
    }

    function initStalkerControls() {
        const searchInput = document.getElementById('stalker-search');
        if (searchInput) searchInput.addEventListener('input', applyStalkerFilter);

        const stalkerHead = document.querySelector('#table-Stalkers thead');
        if (stalkerHead) {
            stalkerHead.addEventListener('click', function (e) {
                const th = e.target.closest('th');
                if (!th || th.classList.contains('actions-col')) return;
                const headers = Array.from(th.parentNode.children);
                const idx = headers.indexOf(th);
                if (idx === 0)      sortStalkers('alias');
                else if (idx === 1) sortStalkers('status');
                else if (idx === 3) sortStalkers('rep');
            });
        }
    }

    const logoBlock = String.raw` +++++++++++++++++++++++++++++++++++++++++++++ 
 +++++++++++++++++++++++++++++++++++++++++++++ 
 ++++++++++++++++++++++ ++++++++++++++++++++++ 
 +++++++++++++++++++++   +++++++++++++++++++++ 
 +++++++++++++++++++++   +++++++++++++++++++++ 
 ++++++   ++++++++++++   ++++++++++++   ++++++ 
 ++++++     ++++++++++   ++++++++++     ++++++ 
 ++++++      +++++++++   +++++++++      ++++++ 
 ++++++  ++   ++++++++   ++++++++   ++  ++++++ 
 ++++++  +++   +++++++   +++++++   +++  ++++++ 
 ++++++  ++++  +++++++   +++++++  ++++  ++++++ 
 ++++++  ++++   ++++++   ++++++   ++++  ++++++ 
 ++++++  ++++   ++++++   ++++++   ++++  ++++++ 
 ++++++  ++++   ++++++   ++++++   ++++  ++++++ 
 ++++++  +++++  ++++++   ++++++   ++++  ++++++ 
 ++++++  +++++  +++++     +++++  +++++  ++++++ 
 ++++++  +++++   ++++     ++++   +++++  ++++++ 
 ++++++  +++     +++   +   +++     +++  ++++++ 
 ++++++  ++   ++++++  +++   +++++   ++  ++++++ 
 ++++++      ++++++   +++   ++++++      ++++++ 
 ++++++  ++    +++   +++++   +++    ++  ++++++ 
 ++++++  ++++       +++++++        +++  ++++++ 
 ++++++  +++++++               +++++++  ++++++ 
 ++++++  +++++++   ++     ++   +++++++  ++++++ 
 ++++++  +++++++   +++   +++   +++++++  ++++++ 
 ++++++                                 ++++++ 
 +++++++++++++++   +++   +++   +++++++++++++++ 
 ++++++++++++++++   ++   ++   ++++++++++++++++ 
  ++++++++++++++++   +   +    ++++++++++++++++ 
   ++++++++++++++++         ++++++++++++++++   
      ++++++++++++++       ++++++++++++++      
           ++++++++++++ +++++++++++++          
               ++++++++++++++++++              
                   +++++++++                   
                       +                       `;

    const logoArt = logoBlock.trimEnd().split("\n");

    const BOOT_MSG = "BOOTING UP FIELD TERMINAL...";
    const logArr = [
        BOOT_MSG,
        "",
        ...logoArt,
        "",
        "SSU FIELD TERMINAL - SenyaOS 4.6",
        "------------------------------------------------",
        "",
        "SYSTEM MEMORY CHECK ............. [OK]",
        "FLASH STORAGE .................... [OK]",
        "EXCLUSION ZONE MAP INDEX ........ [OK]",
        "UHF LINK (CH.12 / ENCRYPTED) .... [READY]",
        "",
        "BOOTING FIELD OPS SHELL..."
    ];

    const logoStartIndex = 2;
    const logoEndIndex = logoStartIndex + logoArt.length - 1;

    let idxBoot = 0;
    let bootSoundPlayed = false;
    let logoWrapper = null;

    function boot() {
        const log = document.getElementById('boot-log');
        log.innerHTML = "";
        idxBoot = 0;
        logoWrapper = null;

        if (!bootSoundPlayed) {
            const ctx = getAudioCtx();
            if (ctx && ctx.state === "suspended") ctx.resume().catch(()=>{});
            playBootSound();
            bootSoundPlayed = true;
        }

        function stepLines() {
            if (idxBoot < logArr.length) {
                const line = logArr[idxBoot];
                const isLogoLine =
                    idxBoot >= logoStartIndex &&
                    idxBoot <= logoEndIndex &&
                    line.trim() !== "";

                if (isLogoLine) {
                    if (!logoWrapper) {
                        logoWrapper = document.createElement('div');
                        logoWrapper.className = 'boot-logo-block';
                        log.appendChild(logoWrapper);
                    }
                    const div = document.createElement('div');
                    div.className = 'boot-line boot-logo-line';
                    div.textContent = line;
                    logoWrapper.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = 'boot-line';
                    div.textContent = line;
                    log.appendChild(div);
                }

                idxBoot++;
                setTimeout(stepLines, 90);
            } else {
                const bar = document.getElementById('bios-bar-fill');
                const statusEl = document.getElementById('bios-status');

                const phases = [
                    { limit: 20, text: "SCANNING MEMORY MAP" },
                    { limit: 45, text: "MOUNTING FIELD DATABASE" },
                    { limit: 70, text: "LINKING RADIO MODULE" },
                    { limit: 90, text: "APPLYING ZONE OVERRIDES" },
                    { limit: 100, text: "HANDING OFF TO OS" }
                ];

                let phaseIndex = 0;
                let p = 0;

                loadFromCloud(true).catch(() => {});

                const itv = setInterval(() => {
                    const step = 8 + Math.floor(Math.random() * 16);
                    p = Math.min(100, p + step);
                    bar.style.width = p + "%";

                    if (phaseIndex < phases.length && p >= phases[phaseIndex].limit) {
                        statusEl.textContent = phases[phaseIndex].text + "...";
                        phaseIndex++;
                    }

                    if (p >= 100) {
                        clearInterval(itv);
                        setTimeout(() => {
                            const bootEl = document.getElementById('boot-screen');
                            if (bootEl) bootEl.style.display = 'none';
                            const cover = document.getElementById('boot-cover');
                            if (cover) cover.style.display = 'none';

                            playBootChime();

                            const frame = document.querySelector('.pda-os-frame');
                            if (frame) {
                                frame.classList.add('pda-appear');
                                setTimeout(() => frame.classList.remove('pda-appear'), 500);
                            }
                        }, 200);
                    }
                }, 90);
            }
        }

        stepLines();
    }

    function initClock() {
        setInterval(() => {
            const d = new Date();
            document.getElementById('pda-clock').innerText =
                d.getHours().toString().padStart(2, '0') + ":" +
                d.getMinutes().toString().padStart(2, '0') + ":" +
                d.getSeconds().toString().padStart(2, '0');
        }, 500);
    }

    function scheduleGlitch() {
        const frame = document.querySelector('.pda-os-frame');
        if (!frame) return;
        const delay = 12000 + Math.random() * 12000;
        setTimeout(() => {
            const bootEl = document.getElementById('boot-screen');
            if (!bootEl || bootEl.style.display === 'none') {
                frame.classList.add('glitch');
                setTimeout(() => frame.classList.remove('glitch'), 160);
            }
            scheduleGlitch();
        }, delay);
    }

    function scheduleBacklightFlicker() {
        if (!backlightOverlay) return;
        const delay = 8000 + Math.random() * 12000;
        setTimeout(() => {
            const bootEl = document.getElementById('boot-screen');
            if (!bootEl || bootEl.style.display === 'none') {
                backlightOverlay.classList.add('active');
                setTimeout(() => backlightOverlay.classList.remove('active'), 800);
            }
            scheduleBacklightFlicker();
        }, delay);
    }

    function startPDA() {
        const startOverlay = document.getElementById('start-overlay');
        if (startOverlay) startOverlay.style.display = 'none';

        const cover = document.getElementById('boot-cover');
        const bootEl = document.getElementById('boot-screen');
        if (cover) cover.style.display = 'block';
        if (bootEl) bootEl.style.display = 'flex';

        const ctx = getAudioCtx();
        if (ctx && ctx.state === "suspended") ctx.resume().catch(()=>{});

        boot();
    }

    window.addEventListener('load', () => {
        initClock();
        initSignalBars();
        initStalkerControls();
        scheduleGlitch();
        scheduleBacklightFlicker();

        const startBtn = document.getElementById('start-btn');
        if (startBtn) startBtn.addEventListener('click', startPDA);
    });
</script>
</body>
</html>
